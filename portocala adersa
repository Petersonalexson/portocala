Sub ImportFromSharePointOnline()
    ' This macro is designed for SharePoint Online files without linked connections
    ' It uses a browser download approach to access the "SPECIFIC SHEET"
    ' Reads URL from cell D7 of sheet 2 and names the new sheet from cell D10
    
    Dim sharePointURL As String
    Dim newSheetName As String
    Dim ws As Worksheet
    Dim ie As Object
    
    ' Error handling
    On Error GoTo ErrorHandler
    
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    
    ' Get the SharePoint URL from cell D7 of sheet 2
    sharePointURL = ThisWorkbook.Sheets(2).Range("D7").Value
    
    ' Get the new sheet name from cell D10 of sheet 2
    newSheetName = ThisWorkbook.Sheets(2).Range("D10").Value
    
    ' Validate inputs
    If Len(sharePointURL) = 0 Then
        MsgBox "Please enter a SharePoint URL in cell D7 of the second sheet!", vbExclamation
        GoTo CleanExit
    End If
    
    If Len(newSheetName) = 0 Then
        MsgBox "Please enter a sheet name in cell D10 of the second sheet!", vbExclamation
        GoTo CleanExit
    End If
    
    ' Create a new sheet after the third sheet
    Set ws = ThisWorkbook.Sheets.Add(After:=ThisWorkbook.Sheets(3))
    ws.Name = newSheetName
    
    ' Create a web query - most compatible approach for SharePoint Online
    With ws.QueryTables.Add(Connection:="URL;" & sharePointURL, Destination:=ws.Range("A1"))
        .WebSelectionType = xlSpecifiedTables
        .WebFormatting = xlWebFormattingAll
        .WebTables = "SPECIFIC SHEET"  ' Target sheet name
        .WebPreFormattedTextToColumns = True
        .WebConsecutiveDelimitersAsOne = False
        .WebSingleBlockTextImport = False
        .WebDisableDateRecognition = True
        .AdjustColumnWidth = True
        
        ' Use a timeout of 60 seconds
        .WebQueryRefreshTimeout = 60
        
        ' Try to refresh in the background first
        On Error Resume Next
        .BackgroundQuery = True
        .Refresh
        
        ' Wait a moment for background refresh to start
        Application.Wait Now + TimeValue("00:00:02")
        
        ' If that fails, try a foreground refresh
        If Err.Number <> 0 Then
            Err.Clear
            .BackgroundQuery = False
            .Refresh
        End If
        
        On Error GoTo ErrorHandler
    End With
    
    ' Display message to user about manual authentication
    MsgBox "If prompted, please sign in to your SharePoint account in the browser window that opens.", vbInformation
    
    ' Process the data to preserve trailing zeros
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    
    ' Wait for data to load
    Application.Wait Now + TimeValue("00:00:03")
    
    ' Add apostrophes to numbers that need preservation
    Dim cell As Range
    For Each cell In ws.UsedRange.Cells
        If IsNumeric(cell.Value) Then
            ' Convert to string to check for trailing zeros
            Dim strVal As String
            strVal = CStr(cell.Value)
            
            ' Check if it has trailing zeros
            If InStr(strVal, ".") > 0 Then
                If Right(strVal, 1) = "0" Then
                    ' Add apostrophe to the value
                    cell.NumberFormat = "@"
                    cell.Value = "'" & strVal
                End If
            End If
        End If
    Next cell
    
    ' If we didn't get any data, provide user with manual options
    If ws.UsedRange.Rows.Count <= 1 And ws.UsedRange.Columns.Count <= 1 Then
        MsgBox "Automatic import may not have worked. Please try these steps:" & vbNewLine & _
               "1. Open the SharePoint file in your browser" & vbNewLine & _
               "2. Download the Excel file" & vbNewLine & _
               "3. Open the downloaded file" & vbNewLine & _
               "4. Copy the 'SPECIFIC SHEET' to this workbook", vbInformation
    Else
        MsgBox "Data has been imported to sheet '" & newSheetName & "'.", vbInformation
    End If
    
CleanExit:
    Application.DisplayAlerts = True
    Application.ScreenUpdating = True
    Application.Calculation = xlCalculationAutomatic
    Exit Sub
    
ErrorHandler:
    Application.DisplayAlerts = True
    Application.ScreenUpdating = True
    Application.Calculation = xlCalculationAutomatic
    
    ' Provide specific guidance for SharePoint Online connection issues
    MsgBox "Error importing data: " & Err.Description & vbNewLine & vbNewLine & _
           "Since you're using SharePoint Online without a linked connection:" & vbNewLine & _
           "1. Open the SharePoint file in your browser" & vbNewLine & _
           "2. Download the Excel file" & vbNewLine & _
           "3. Open the downloaded file" & vbNewLine & _
           "4. Copy the 'SPECIFIC SHEET' to this workbook", vbExclamation
End Sub
